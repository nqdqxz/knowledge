<!-- 2017/9/5 -->

# js单线程模型

工作线程将消息放到消息队列，主线程利用事件循环机制处理消息。
<!--more-->

## 一、js单线程

JS引擎解释和执行JS代码的线程只有一个，为主线程。即JS同时只能执行一个任务，其他任务须排队等待。

其他线程在后台配合，为工作线程。如：处理ajax请求的线程，处理dom事件的线程，定时器线程，读写文件的线程。

## 二、消息队列

JS引擎除了一个运行线程，还提供一个消息队列。新消息进入队列时，会自动排在队列尾端。

每条消息与一个回调函数相联系。如果消息没有回调函数，则消息被遗弃。

特殊情况：`setTimeout`在指定时间向消息队列添加消息，这条消息须等到其他消息处理完，才会得到处理。

若当前执行栈空了，消息队列会取出第一位消息，传入程序。程序开始执行对应回调函数，等执行完，再处理下条消息。

## 三、事件循环

主线程只会做一件事：一轮又一轮地从消息队列的取消息，执行对应的回调函数。这种机制叫做事件循环机制，取一个消息并执行的过程叫做一次循环。

1、同步任务：在JS执行进程上排队执行的任务，前个任务执行完毕，才执行后一个任务

2、异步任务：不进入JS执行进程、而进入"任务队列"的任务。只有"任务队列"通知主进程可执行某个异步任务，该任务才会进入JS进程执行。

## 四、异步过程

1、概念：

主线程发起异步请求，相应工作线程接收请求并告知主线程已收到(异步函数返回)；主线程继续执行后面代码，工作线程执行异步任务；工作线程完成工作后，通知主线程；主线程收到通知后，调用回调函数。

2、通知的过程

工作线程将消息放到消息队列，主线程通过事件循环去取消息。

3、生产者和消费者的角度解释

工作线程是生产者，主线程是唯一的消费者。工作线程执行异步任务，执行完成后把对应的回调函数封装成一条消息放到消息队列中；主线程不断地从消息队列中取消息并执行，当消息队列空时主线程阻塞，直到消息队列再次非空。

## 五、参考文档

- [单线程模型](http://javascript.ruanyifeng.com/advanced/single-thread.html)
- [JavaScript：彻底理解同步、异步和事件循环(Event Loop)](https://segmentfault.com/a/1190000004322358)
